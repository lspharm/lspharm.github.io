<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—æ–°é†«é™¢è™•æ–¹é›† | Lin Shin Hospital Formulary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* é ç•™é ‚éƒ¨ç©ºé–“ */
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif; padding-top: 190px; }
        
        /* å›ºå®šç½®é ‚å€åŸŸ - é è¨­è—è‰² (è—¥å“) */
        .fixed-header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; padding: 15px 0 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: background 0.5s ease;
        }

        /* é£Ÿå“æ¨¡å¼å°ˆç”¨é»ƒè‰²æ¨£å¼ */
        .fixed-header.food-mode {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: #333;
        }
        .fixed-header.food-mode .mode-btn { color: rgba(0,0,0,0.6); }
        .fixed-header.food-mode .mode-btn.active { background: white; color: #d35400; }
        .fixed-header.food-mode .filter-btn { border-color: rgba(0,0,0,0.2); background: rgba(0,0,0,0.05); color: #333; }
        .fixed-header.food-mode .filter-btn.active { background: #333; color: #FFC107; border-color: #333; }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switch-container {
            display: flex; justify-content: center; margin-bottom: 12px;
            background: rgba(0,0,0,0.2); padding: 4px; border-radius: 25px;
            width: fit-content; margin-left: auto; margin-right: auto;
        }
        .mode-btn {
            border: none; background: transparent; color: rgba(255,255,255,0.7);
            padding: 5px 20px; border-radius: 20px; font-size: 0.95rem; font-weight: bold; transition: all 0.2s;
        }
        .mode-btn.active { background: white; color: #1e3c72; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* æœå°‹èˆ‡ç¯©é¸ */
        .search-container { max-width: 700px; margin: 0 auto; padding: 0 15px; }
        .filter-container { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-top: 10px; 
            justify-content: flex-start; -webkit-overflow-scrolling: touch; 
        }
        @media (min-width: 768px) { .filter-container { justify-content: center; } }

        .filter-btn { 
            white-space: nowrap; border-radius: 20px; padding: 5px 14px; font-size: 0.85rem; 
            border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-btn.active { background: #fff; color: #1e3c72; font-weight: bold; border-color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* å¡ç‰‡è¨­è¨ˆ */
        .drug-card { 
            border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            height: 100%; cursor: pointer; background: white; transition: transform 0.2s;
            display: flex; flex-direction: column; 
        }
        .drug-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-left: 5px solid #2a5298; }
        .card-body { padding: 1.25rem; flex: 1; }
        
        /* æ’ç‰ˆèˆ‡è‰²å¡Š */
        .text-content, .block-content { white-space: pre-line; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.6; color: #333; }
        .block-label { font-size: 0.85rem; font-weight: bold; opacity: 0.8; margin-bottom: 4px; display: block; }
        
        .block-ingredient { background-color: #f3e5f5; color: #6a1b9a; border-left: 4px solid #6a1b9a; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-indication { background-color: #e7f5ff; color: #0056b3; border-left: 4px solid #0056b3; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-usage { background-color: #f0fdf4; color: #15803d; border-left: 4px solid #15803d; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-storage { background-color: #fff7ed; color: #9a3412; border-left: 4px solid #9a3412; padding: 10px; border-radius: 4px; margin-bottom: 10px; }

        .info-row { margin-bottom: 10px; display: flex; flex-direction: column; }
        .info-label { font-weight: bold; color: #555; font-size: 0.9rem; margin-bottom: 2px; }
        .divider { border-top: 1px dashed #e0e0e0; margin: 12px 0; }
        .badge-code { background-color: #6c757d; color: white; font-size: 0.9rem;}
        .text-nhi { color: #0d6efd; font-weight: bold; } 
        
        .modal-header { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .detail-title { color: #1e3c72; font-weight: bold; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; }
        .detail-content { background: #fff; padding: 10px; border-radius: 6px; }
        .alert-box { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; }
        
        .filter-container::-webkit-scrollbar { height: 4px; }
        .filter-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    </style>
</head>
<body>

<div class="fixed-header" id="myHeader">
    <div class="container text-center">
        <h4 class="mb-2 fw-bold d-none d-md-block"><i class="fas fa-capsules me-2"></i>æ—æ–°é†«é™¢è—¥å“è™•æ–¹é›†</h4>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" id="btnModeDrug" onclick="switchMode('DRUG')">ğŸ’Š è—¥å“æŸ¥è©¢</button>
            <button class="mode-btn" id="btnModeFood" onclick="switchMode('FOOD')">ğŸ é£Ÿå“/ç‡Ÿé¤Šå“</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="form-control shadow-sm" placeholder="è¼¸å…¥åç¨±ã€æˆåˆ†ã€ä»£ç¢¼..." autocomplete="off" disabled>
            
            <div class="filter-container" id="drugFilters">
                <button class="filter-btn active" onclick="setFilter('ALL', this)">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="setFilter('O', this)">å£æœ (O)</button>
                <button class="filter-btn" onclick="setFilter('I', this)">é‡åŠ‘ (I)</button>
                <button class="filter-btn" onclick="setFilter('E', this)">å¤–ç”¨ (E)</button>
                <button class="filter-btn" onclick="setFilter('P', this)">çœ¼ç”¨ (P)</button>
                <button class="filter-btn" onclick="setFilter('L', this)">æ°´åŠ‘ (L)</button>
                <button class="filter-btn" onclick="setFilter('J', this)">æ´—è…å°ˆç”¨ (J)</button>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5" id="mainContainer">
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <span class="fw-bold text-primary" id="resultCount">è³‡æ–™åº«é€£ç·šä¸­...</span>
    </div>
    <div id="drugList" class="row g-4"></div>
</div>

<div class="modal fade" id="drugModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge badge-code mb-1" id="modalCode">Code</span>
                            <span class="badge bg-secondary mb-1" id="modalNhiCode" style="display:none;">å¥ä¿ç¢¼</span>
                        </div>
                        <span class="badge bg-info text-dark" id="modalClass">è—¥ç†åˆ†é¡</span>
                    </div>
                    <h3 class="modal-title fw-bold mt-2" id="modalTitle">è—¥å“åç¨±</h3>
                    <div class="text-secondary mt-1"><i class="fas fa-flask me-1"></i><span id="modalIngr">æˆä»½</span></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left: 10px;"></button>
            </div>
            <div class="modal-body p-4" id="modalBody"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let drugList = [];     // è—¥å“æ¸…å–®
    let foodList = [];     // é£Ÿå“æ¸…å–®
    let currentMode = 'DRUG'; 
    let currentCategory = 'ALL'; 
    const csvFileName = "drugs.csv?t=" + new Date().getTime(); 

    // --- è‡ªå‹•èª¿æ•´ç‰ˆé¢åŠŸèƒ½ ---
    function adjustLayout() {
        const header = document.getElementById('myHeader');
        if(header) {
            const height = header.offsetHeight;
            document.body.style.paddingTop = (height + 20) + 'px';
        }
    }
    window.addEventListener('resize', adjustLayout);


    Papa.parse(csvFileName, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
            const excludePrefixes = ['X', 'F', 'N']; 
            
            results.data.forEach(item => {
                const pharmName = (item['è—¥ç†åˆ†é¡åç¨±'] || '').trim();
                const code = (item['ä»£ç¢¼'] || item['é™¢å…§ä»£ç¢¼'] || Object.values(item)[0] || '').trim().toUpperCase();

                // 1. åš´æ ¼éæ¿¾åƒåœ¾è³‡æ–™
                if (code.length > 0 && excludePrefixes.includes(code.charAt(0))) {
                    return; 
                }

                // 2. åˆ†æµï¼šè—¥å“ vs é£Ÿå“
                if (pharmName.includes('é£Ÿå“') || pharmName.includes('ç‡Ÿé¤Š')) {
                    foodList.push(item);
                } else {
                    drugList.push(item);
                }
            });

            document.getElementById('searchInput').disabled = false;
            switchMode('DRUG'); // é è¨­é¡¯ç¤ºè—¥å“
        },
        error: function(err) {
            document.getElementById('resultCount').innerText = "è®€å–å¤±æ•—";
        }
    });

    // --- æ¨¡å¼åˆ‡æ›é‚è¼¯ (å«é¡è‰²åˆ‡æ›) ---
    window.switchMode = function(mode) {
        currentMode = mode;
        const header = document.getElementById('myHeader');
        
        // åˆ‡æ›æŒ‰éˆ•èˆ‡èƒŒæ™¯
        document.getElementById('btnModeDrug').classList.toggle('active', mode === 'DRUG');
        document.getElementById('btnModeFood').classList.toggle('active', mode === 'FOOD');

        const filterDiv = document.getElementById('drugFilters');
        
        if (mode === 'DRUG') {
            filterDiv.style.display = 'flex';
            header.classList.remove('food-mode'); // è—è‰²
        } else {
            filterDiv.style.display = 'none';
            header.classList.add('food-mode'); // é»ƒè‰²
        }

        currentCategory = 'ALL';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        if(document.querySelector('.filter-btn')) document.querySelector('.filter-btn').classList.add('active');
        
        document.getElementById('searchInput').value = ''; 
        setTimeout(adjustLayout, 10);
        applyFilters();
    };

    window.setFilter = function(category, btnElement) {
        currentCategory = category;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        applyFilters();
    };

    function applyFilters() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        
        // 1. æ±ºå®šè¦æœå“ªå€‹æ¸…å–®
        let targetList = (currentMode === 'DRUG') ? drugList : foodList;
        let result = targetList;

        if (currentMode === 'DRUG' && currentCategory !== 'ALL') {
            result = result.filter(item => {
                const code = (item['ä»£ç¢¼'] || item['é™¢å…§ä»£ç¢¼'] || Object.values(item)[0] || '').trim().toUpperCase();
                return code.startsWith(currentCategory);
            });
        }

        if (keyword) {
            let scoredResults = result.map(item => {
                let score = 0;
                // æ›´æ–°ï¼šå°æ‡‰æ–°CSVçš„æ¬„ä½åç¨±
                const name = (item['åç¨±'] || item['è—¥å“åç¨±'] || '').toLowerCase();
                const ingr = (item['ä¸»è¦æˆä»½'] || '').toLowerCase();
                const code = (item['ä»£ç¢¼'] || item['é™¢å…§ä»£ç¢¼'] || '').toLowerCase();

                // æ¬Šé‡è¦å‰‡
                if (name.includes(keyword) || ingr.includes(keyword)) score = 10;
                else if (code.includes(keyword)) score = 5;
                else if (Object.values(item).some(val => String(val).toLowerCase().includes(keyword))) score = 1;

                return { item, score };
            });

            result = scoredResults
                .filter(x => x.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(x => x.item);
        }

        const modeName = (currentMode === 'DRUG') ? 'è—¥å“' : 'é£Ÿå“/ç‡Ÿé¤Šå“';
        document.getElementById('resultCount').innerText = `${modeName}æœå°‹çµæœï¼šå…± ${result.length} ç­†`;
        renderDrugs(result.slice(0, 50));
        setTimeout(adjustLayout, 10);
    }
    
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    function renderDrugs(items) {
        const container = document.getElementById('drugList');
        container.innerHTML = '';
        
        if (items.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">ç„¡ç¬¦åˆè³‡æ–™</div>';
            return;
        }

        items.forEach((item) => {
            const getStr = (key) => (item[key] || '').trim();
            // å°æ‡‰ CSV æ¬„ä½
            const name = item['åç¨±'] || item['è—¥å“åç¨±'] || '';
            const code = item['ä»£ç¢¼'] || item['é™¢å…§ä»£ç¢¼'] || '';

            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 col-sm-12';
            col.innerHTML = `
                <div class="card drug-card" onclick='openDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge badge-code">${code}</span>
                        </div>
                        
                        <h4 class="card-title fw-bold text-primary mb-2">${name}</h4>
                        <div class="text-secondary small mb-3"><i class="fas fa-flask me-1"></i>${getStr('ä¸»è¦æˆä»½')}</div>
                        
                        ${getStr('è—¥ç†åˆ†é¡åç¨±') ? `<div class="badge bg-light text-dark border mb-3" style="white-space: normal; text-align:left;">${getStr('è—¥ç†åˆ†é¡åç¨±')}</div>` : ''}

                        ${getStr('ä¸»è¦æˆä»½') ? `<div class="block-ingredient"><span class="block-label"><i class="fas fa-flask me-1"></i>ä¸»è¦æˆä»½</span><div class="block-content">${getStr('ä¸»è¦æˆä»½')}</div></div>` : ''}
                        ${getStr('é©æ‡‰ç—‡') ? `<div class="block-indication"><span class="block-label"><i class="fas fa-stethoscope me-1"></i>é©æ‡‰ç—‡</span><div class="block-content">${getStr('é©æ‡‰ç—‡')}</div></div>` : ''}
                        ${getStr('åŠ‘é‡åŠç”¨æ³•') ? `<div class="block-usage"><span class="block-label"><i class="fas fa-clock me-1"></i>ç”¨æ³•</span><div class="block-content">${getStr('åŠ‘é‡åŠç”¨æ³•')}</div></div>` : ''}
                        ${getStr('è—¥å“è©²å¦‚ä½•å­˜æ”¾') ? `<div class="block-storage"><span class="block-label"><i class="fas fa-temperature-low me-1"></i>å­˜æ”¾</span><div class="block-content">${getStr('è—¥å“è©²å¦‚ä½•å­˜æ”¾')}</div></div>` : ''}
                        
                        ${getStr('è‡¨åºŠç”¨é€”(ä¸­æ–‡)') ? `<div class="info-row mt-2"><span class="info-label text-nhi">å¥ä¿è¦ç¯„:</span><span class="text-content text-nhi">${getStr('è‡¨åºŠç”¨é€”(ä¸­æ–‡)')}</span></div>` : ''}
                        ${getStr('ä½œç”¨') ? `<div class="info-row mt-2"><span class="info-label">ä½œç”¨:</span><span class="text-content text-muted">${getStr('ä½œç”¨')}</span></div>` : ''}
                        
                        ${(getStr('æ³¨æ„äº‹é …1') || getStr('æ³¨æ„äº‹é …')) ? `<div class="mt-2 p-2 bg-light border rounded small text-danger text-content"><i class="fas fa-exclamation-circle me-1"></i>${getStr('æ³¨æ„äº‹é …1') || getStr('æ³¨æ„äº‹é …')}</div>` : ''}
                            
                        ${getStr('å„²å­˜æ–¹å¼') ? `<div class="divider"></div><div class="text-end text-muted small">å„²ä½: ${getStr('å„²å­˜æ–¹å¼')}</div>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(col);
        });
    }

    window.openDetail = function(item) {
        const getStr = (key) => (item[key] || '').trim();
        document.getElementById('modalTitle').innerText = item['åç¨±'] || item['è—¥å“åç¨±'] || '';
        document.getElementById('modalCode').innerText = item['ä»£ç¢¼'] || item['é™¢å…§ä»£ç¢¼'] || '';
        document.getElementById('modalIngr').innerText = getStr('ä¸»è¦æˆä»½');
        document.getElementById('modalClass').innerText = getStr('è—¥ç†åˆ†é¡åç¨±') || 'æœªåˆ†é¡';
        
        // é¡¯ç¤ºå¥ä¿ç¢¼ (å¦‚æœæœ‰)
        const nhiCode = getStr('å¥ä¿ç¢¼');
        const badgeNhi = document.getElementById('modalNhiCode');
        if(nhiCode && nhiCode !== '0') {
            badgeNhi.innerText = `å¥ä¿ç¢¼: ${nhiCode}`;
            badgeNhi.style.display = 'inline-block';
        } else {
            badgeNhi.style.display = 'none';
        }
        
        let html = '';
        if (getStr('ä¸»è¦æˆä»½')) html += `<div class="block-ingredient"><span class="block-label"><i class="fas fa-flask me-1"></i>ä¸»è¦æˆä»½</span><div class="block-content">${getStr('ä¸»è¦æˆä»½')}</div></div>`;
        if (getStr('é©æ‡‰ç—‡')) html += `<div class="block-indication"><span class="block-label"><i class="fas fa-stethoscope me-1"></i>é©æ‡‰ç—‡</span><div class="block-content">${getStr('é©æ‡‰ç—‡')}</div></div>`;
        if (getStr('åŠ‘é‡åŠç”¨æ³•')) html += `<div class="block-usage"><span class="block-label"><i class="fas fa-clock me-1"></i>åŠ‘é‡åŠç”¨æ³•</span><div class="block-content">${getStr('åŠ‘é‡åŠç”¨æ³•')}</div></div>`;
        if (getStr('è—¥å“è©²å¦‚ä½•å­˜æ”¾')) html += `<div class="block-storage"><span class="block-label"><i class="fas fa-temperature-low me-1"></i>è—¥å“è©²å¦‚ä½•å­˜æ”¾</span><div class="block-content">${getStr('è—¥å“è©²å¦‚ä½•å­˜æ”¾')}</div></div>`;

        if (getStr('è‡¨åºŠç”¨é€”(ä¸­æ–‡)')) html += `<div class="detail-title"><i class="fas fa-file-invoice-dollar me-2"></i>å¥ä¿çµ¦ä»˜è¦ç¯„</div><div class="detail-content text-content text-nhi">${getStr('è‡¨åºŠç”¨é€”(ä¸­æ–‡)')}</div>`;
        if (getStr('ä½œç”¨')) html += `<div class="detail-title"><i class="fas fa-bolt me-2"></i>ä½œç”¨</div><div class="detail-content text-content">${getStr('ä½œç”¨')}</div>`;
        
        const warning = getStr('æ³¨æ„äº‹é …1') || getStr('æ³¨æ„äº‹é …');
        if (warning) html += `<div class="detail-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>æ³¨æ„äº‹é …</div><div class="alert-box text-content">${warning}</div>`;
        
        if (getStr('å„²å­˜æ–¹å¼')) html += `<div class="mt-4 text-end text-muted border-top pt-2">å€‰åº«/è—¥å±€å„²ä½ï¼š${getStr('å„²å­˜æ–¹å¼')}</div>`;

        document.getElementById('modalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('drugModal')).show();
    };
</script>
</body>
</html>
