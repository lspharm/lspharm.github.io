<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—æ–°é†«é™¢è™•æ–¹é›† | Lin Shin Hospital Formulary</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* é ç•™é ‚éƒ¨ç©ºé–“ */
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", "Heiti TC", Arial, sans-serif; padding-top: 240px; }
        
        /* å›ºå®šç½®é ‚å€åŸŸ */
        .fixed-header {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white; padding: 15px 0 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: background 0.5s ease;
        }

        /* é£Ÿå“æ¨¡å¼å°ˆç”¨é»ƒè‰²æ¨£å¼ */
        .fixed-header.food-mode {
            background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%);
            color: #333;
        }
        .fixed-header.food-mode .mode-btn { color: rgba(0,0,0,0.6); }
        .fixed-header.food-mode .mode-btn.active { background: white; color: #d35400; }
        .fixed-header.food-mode .filter-btn { border-color: rgba(0,0,0,0.2); background: rgba(0,0,0,0.05); color: #333; }
        .fixed-header.food-mode .filter-btn.active { background: #333; color: #FFC107; border-color: #333; }

        /* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */
        .mode-switch-container {
            display: flex; justify-content: center; margin-bottom: 8px;
            background: rgba(0,0,0,0.2); padding: 4px; border-radius: 25px;
            width: fit-content; margin-left: auto; margin-right: auto;
        }
        .mode-btn {
            border: none; background: transparent; color: rgba(255,255,255,0.7);
            padding: 5px 20px; border-radius: 20px; font-size: 0.95rem; font-weight: bold; transition: all 0.2s;
        }
        .mode-btn.active { background: white; color: #1e3c72; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* æœå°‹èˆ‡ç¯©é¸ */
        .search-container { max-width: 700px; margin: 0 auto; padding: 0 15px; }
        
        /* è—¥ç†åˆ†é¡ä¸‹æ‹‰é¸å–® */
        .pharm-select {
            width: 100%; padding: 8px 12px; margin-top: 8px;
            border-radius: 8px; border: 1px solid rgba(255,255,255,0.5);
            background-color: rgba(255,255,255,0.9); color: #333; font-size: 0.95rem;
            text-overflow: ellipsis; white-space: nowrap; overflow: hidden;
        }
        .pharm-select:focus { outline: none; border-color: #fff; box-shadow: 0 0 0 2px rgba(255,255,255,0.5); }

        .filter-container { 
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-top: 10px; 
            justify-content: flex-start; -webkit-overflow-scrolling: touch; 
        }
        @media (min-width: 768px) { .filter-container { justify-content: center; } }

        .filter-btn { 
            white-space: nowrap; border-radius: 20px; padding: 5px 14px; font-size: 0.85rem; 
            border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; transition: all 0.2s;
        }
        .filter-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .filter-btn.active { background: #fff; color: #1e3c72; font-weight: bold; border-color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* å¡ç‰‡è¨­è¨ˆ */
        .drug-card { 
            border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            height: 100%; cursor: pointer; background: white; transition: transform 0.2s;
            display: flex; flex-direction: column; 
        }
        .drug-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); border-left: 5px solid #2a5298; }
        .card-body { padding: 1.25rem; flex: 1; }
        
        /* æ’ç‰ˆèˆ‡è‰²å¡Š */
        .text-content, .block-content { white-space: pre-line; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.6; color: #333; }
        .block-label { font-size: 0.85rem; font-weight: bold; opacity: 0.8; margin-bottom: 4px; display: block; }
        
        .block-ingredient { background-color: #f3e5f5; color: #6a1b9a; border-left: 4px solid #6a1b9a; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-indication { background-color: #e7f5ff; color: #0056b3; border-left: 4px solid #0056b3; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-usage { background-color: #f0fdf4; color: #15803d; border-left: 4px solid #15803d; padding: 10px; border-radius: 4px; margin-bottom: 10px; }
        .block-storage { background-color: #fff7ed; color: #9a3412; border-left: 4px solid #9a3412; padding: 10px; border-radius: 4px; margin-bottom: 10px; }

        .info-row { margin-bottom: 10px; display: flex; flex-direction: column; }
        .info-label { font-weight: bold; color: #555; font-size: 0.9rem; margin-bottom: 2px; }
        .divider { border-top: 1px dashed #e0e0e0; margin: 12px 0; }
        
        .badge-code { background-color: #6c757d; color: white; font-size: 0.9rem;}
        .badge-nhi { background-color: #198754; color: white; font-size: 0.9rem; margin-right: 5px; }
        
        .text-nhi { color: #0d6efd; font-weight: bold; } 
        
        .modal-header { background-color: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .detail-title { color: #1e3c72; font-weight: bold; margin: 20px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; }
        .detail-content { background: #fff; padding: 10px; border-radius: 6px; }
        .alert-box { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 15px; border-radius: 8px; }
        
        /* åˆå§‹æç¤ºå€å¡Š */
        .empty-state { text-align: center; padding: 50px 20px; color: #6c757d; }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
        
        /* è¼‰å…¥æ›´å¤šæŒ‰éˆ• */
        .load-more-btn {
            display: block; width: 100%; max-width: 300px; margin: 20px auto;
            padding: 12px; border-radius: 25px; border: 2px solid #2a5298;
            background: white; color: #2a5298; font-weight: bold;
            transition: all 0.2s;
        }
        .load-more-btn:hover { background: #2a5298; color: white; }

        .filter-container::-webkit-scrollbar { height: 4px; }
        .filter-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    </style>
</head>
<body>

<div class="fixed-header" id="myHeader">
    <div class="container text-center">
        <h4 class="mb-2 fw-bold d-none d-md-block"><i class="fas fa-capsules me-2"></i>æ—æ–°é†«é™¢è—¥å“è™•æ–¹é›†</h4>
        
        <div class="mode-switch-container">
            <button class="mode-btn active" id="btnModeDrug" onclick="switchMode('DRUG')">ğŸ’Š è—¥å“æŸ¥è©¢</button>
            <button class="mode-btn" id="btnModeFood" onclick="switchMode('FOOD')">ğŸ é£Ÿå“/ç‡Ÿé¤Šå“</button>
        </div>

        <div class="search-container">
            <input type="text" id="searchInput" class="form-control shadow-sm" placeholder="è¼¸å…¥åç¨±ã€æˆåˆ†ã€ä»£ç¢¼..." autocomplete="off" disabled>
            
            <select id="pharmSelect" class="pharm-select" onchange="applyFilters()">
                <option value="">ğŸ“‚ ä¾è—¥ç†åˆ†é¡ç¯©é¸ (å…¨éƒ¨)</option>
            </select>

            <div class="filter-container" id="drugFilters">
                <button class="filter-btn active" onclick="setFilter('ALL', this)">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="setFilter('O', this)">å£æœ (O)</button>
                <button class="filter-btn" onclick="setFilter('I', this)">é‡åŠ‘ (I)</button>
                <button class="filter-btn" onclick="setFilter('E', this)">å¤–ç”¨ (E)</button>
                <button class="filter-btn" onclick="setFilter('P', this)">çœ¼ç”¨ (P)</button>
                <button class="filter-btn" onclick="setFilter('L', this)">æ°´åŠ‘ (L)</button>
                <button class="filter-btn" onclick="setFilter('J', this)">æ´—è…å°ˆç”¨ (J)</button>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5" id="mainContainer">
    <div class="d-flex justify-content-between align-items-center mb-3 px-2">
        <span class="fw-bold text-primary" id="resultCount"></span>
    </div>
    <div id="errorBox" class="alert alert-danger" style="display:none;"></div>
    <div id="drugList" class="row g-4"></div>
    <div id="loadMoreContainer"></div> 
</div>

<div class="modal fade" id="drugModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <div class="w-100">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="badge badge-code mb-1" id="modalCode">Code</span>
                            <span class="badge badge-nhi mb-1" id="modalNhiCode" style="display:none;">å¥ä¿ç¢¼</span>
                        </div>
                        <span class="badge bg-info text-dark" id="modalClass">è—¥ç†åˆ†é¡</span>
                    </div>
                    <h3 class="modal-title fw-bold mt-2" id="modalTitle">è—¥å“åç¨±</h3>
                    <h5 class="text-primary fw-bold" id="modalChineseTitle">ä¸­æ–‡å“å</h5>
                    <div class="text-secondary mt-1"><i class="fas fa-flask me-1"></i><span id="modalIngr">æˆä»½</span></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="margin-left: 10px;"></button>
            </div>
            <div class="modal-body p-4" id="modalBody"></div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ç§»é™¤é©—è­‰é‚è¼¯ï¼Œç›´æ¥å…¬é–‹å­˜å–
    const ITEMS_PER_PAGE = 20; 
    let currentLimit = ITEMS_PER_PAGE;
    let currentFilteredData = []; 

    let drugList = [];     
    let foodList = [];     
    let currentMode = 'DRUG'; 
    let currentCategory = 'ALL'; 
    const csvFileName = "drugs.csv?t=" + new Date().getTime(); 

    function adjustLayout() {
        const header = document.getElementById('myHeader');
        if(header) {
            const height = header.offsetHeight;
            document.body.style.paddingTop = (height + 20) + 'px';
        }
    }
    window.addEventListener('resize', adjustLayout);

    function getValue(item, keys) {
        if (!Array.isArray(keys)) keys = [keys];
        for (let key of keys) {
            if (item[key] !== undefined && item[key] !== null) {
                return String(item[key]).trim();
            }
        }
        return '';
    }

    function populatePharmSelect(items) {
        const select = document.getElementById('pharmSelect');
        const currentVal = select.value;
        select.innerHTML = '<option value="">ğŸ“‚ ä¾è—¥ç†åˆ†é¡ç¯©é¸ (å…¨éƒ¨)</option>';
        const pharmMap = new Map();

        items.forEach(item => {
            const id = getValue(item, ['è—¥ç†åˆ†é¡']);
            const name = getValue(item, ['è—¥ç†åˆ†é¡åç¨±']);
            if (id && name) {
                const key = `${id} - ${name}`;
                if (!pharmMap.has(key)) {
                    pharmMap.set(key, { id: id, name: name });
                }
            }
        });

        const sortedKeys = Array.from(pharmMap.keys()).sort();
        sortedKeys.forEach(key => {
            const data = pharmMap.get(key);
            const option = document.createElement('option');
            option.value = data.id; 
            option.text = `${data.id} ${data.name}`;
            select.appendChild(option);
        });
        
        if (currentVal) {
             const exists = Array.from(select.options).some(opt => opt.value === currentVal);
             if(exists) select.value = currentVal;
        }
    }

    Papa.parse(csvFileName, {
        download: true, 
        header: true, 
        skipEmptyLines: true,
        transformHeader: function(h) { return h.replace(/^\ufeff/, '').trim(); },
        complete: function(results) {
            const excludePrefixes = ['X', 'F', 'N']; 
            
            if (results.data.length === 0) {
                document.getElementById('resultCount').innerText = "è®€å–åˆ°çš„è³‡æ–™ç‚º 0 ç­†";
                return;
            }

            results.data.forEach(item => {
                const pharmName = getValue(item, ['è—¥ç†åˆ†é¡åç¨±', 'è—¥ç†åˆ†é¡']);
                const code = getValue(item, ['ä»£ç¢¼', 'é™¢å…§ä»£ç¢¼', 'è—¥å“ä»£ç¢¼']).toUpperCase();
                const name = getValue(item, ['åç¨±', 'è—¥å“åç¨±', 'ä¸­æ–‡å“å']);
                const type = getValue(item, ['ä¸­è¥¿è—¥åˆ¥', 'è—¥åˆ¥']);

                if (!name && !code) return;
                if (type === 'åœç”¨') return; 

                if (code.length > 0 && excludePrefixes.includes(code.charAt(0))) return; 

                if (pharmName.includes('é£Ÿå“') || pharmName.includes('ç‡Ÿé¤Š')) {
                    foodList.push(item);
                } else {
                    drugList.push(item);
                }
            });

            document.getElementById('searchInput').disabled = false;
            switchMode('DRUG'); 
            setTimeout(adjustLayout, 100); // ç¢ºä¿è¼‰å…¥å¾Œç‰ˆé¢æ­£ç¢º
        },
        error: function(err) {
            document.getElementById('resultCount').innerText = "è®€å–å¤±æ•—";
        }
    });

    window.switchMode = function(mode) {
        currentMode = mode;
        const header = document.getElementById('myHeader');
        
        document.getElementById('btnModeDrug').classList.toggle('active', mode === 'DRUG');
        document.getElementById('btnModeFood').classList.toggle('active', mode === 'FOOD');

        const filterDiv = document.getElementById('drugFilters');
        
        if (mode === 'DRUG') {
            filterDiv.style.display = 'flex';
            header.classList.remove('food-mode'); 
            populatePharmSelect(drugList);
        } else {
            filterDiv.style.display = 'none';
            header.classList.add('food-mode'); 
            populatePharmSelect(foodList);
        }
        
        document.getElementById('pharmSelect').value = "";
        currentCategory = 'ALL';
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        if(document.querySelector('.filter-btn')) document.querySelector('.filter-btn').classList.add('active');
        
        document.getElementById('searchInput').value = ''; 
        setTimeout(adjustLayout, 10);
        applyFilters();
    };

    window.setFilter = function(category, btnElement) {
        currentCategory = category;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        btnElement.classList.add('active');
        applyFilters();
    };

    function applyFilters() {
        const keyword = document.getElementById('searchInput').value.toLowerCase().trim();
        const pharmSelectVal = document.getElementById('pharmSelect').value.toLowerCase().trim();
        
        let targetList = (currentMode === 'DRUG') ? drugList : foodList;
        let result = targetList;

        if (!keyword && !pharmSelectVal && currentCategory === 'ALL') {
             document.getElementById('resultCount').innerText = "";
             document.getElementById('drugList').innerHTML = `
                <div class="col-12 empty-state">
                    <i class="fas fa-search"></i>
                    <h4>è«‹è¼¸å…¥é—œéµå­—æˆ–é¸æ“‡åˆ†é¡é–‹å§‹æŸ¥è©¢</h4>
                </div>
             `;
             document.getElementById('loadMoreContainer').innerHTML = ""; 
             return;
        }

        if (pharmSelectVal) {
            result = result.filter(item => {
                const pId = getValue(item, ['è—¥ç†åˆ†é¡']).toLowerCase();
                return pId.includes(pharmSelectVal);
            });
        }

        if (currentMode === 'DRUG' && currentCategory !== 'ALL') {
            result = result.filter(item => {
                const code = getValue(item, ['ä»£ç¢¼', 'é™¢å…§ä»£ç¢¼']).toUpperCase();
                return code.startsWith(currentCategory);
            });
        }

        if (keyword) {
            let scoredResults = result.map(item => {
                let score = 0;
                const name = getValue(item, ['åç¨±', 'è—¥å“åç¨±']).toLowerCase();
                const chineseName = getValue(item, ['ä¸­æ–‡å“å', 'ä¸­æ–‡åç¨±']).toLowerCase();
                const ingr = getValue(item, ['ä¸»è¦æˆä»½', 'æˆä»½']).toLowerCase();
                const code = getValue(item, ['ä»£ç¢¼', 'é™¢å…§ä»£ç¢¼']).toLowerCase();

                if (ingr.includes(keyword)) score += 100;
                if (name.includes(keyword)) score += 80;
                if (chineseName.includes(keyword)) score += 60;
                if (code.includes(keyword)) score += 40;
                
                if (Object.values(item).some(val => String(val).toLowerCase().includes(keyword))) score += 1;

                return { item, score };
            });

            result = scoredResults
                .filter(x => x.score > 0)
                .sort((a, b) => b.score - a.score)
                .map(x => x.item);
        }

        currentLimit = ITEMS_PER_PAGE;
        currentFilteredData = result; 
        
        renderDrugs(); 
        setTimeout(adjustLayout, 10);
    }
    
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    function loadMore() {
        currentLimit += ITEMS_PER_PAGE;
        renderDrugs();
    }

    function renderDrugs() {
        const container = document.getElementById('drugList');
        const loadMoreContainer = document.getElementById('loadMoreContainer');
        container.innerHTML = '';
        loadMoreContainer.innerHTML = ''; 

        const totalItems = currentFilteredData.length;
        const modeName = (currentMode === 'DRUG') ? 'è—¥å“' : 'é£Ÿå“/ç‡Ÿé¤Šå“';
        
        if (totalItems === 0) {
            document.getElementById('resultCount').innerText = `${modeName}æœå°‹çµæœï¼šå…± 0 ç­†`;
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">ç„¡ç¬¦åˆè³‡æ–™</div>';
            return;
        }

        const itemsToShow = currentFilteredData.slice(0, currentLimit);
        document.getElementById('resultCount').innerText = `${modeName}æœå°‹ï¼šé¡¯ç¤ºå‰ ${itemsToShow.length} ç­† (å…± ${totalItems} ç­†)`;

        itemsToShow.forEach((item) => {
            const name = getValue(item, ['åç¨±', 'è—¥å“åç¨±']);
            const chineseName = getValue(item, ['ä¸­æ–‡å“å', 'ä¸­æ–‡åç¨±']);
            const code = getValue(item, ['ä»£ç¢¼', 'é™¢å…§ä»£ç¢¼']);
            const ingredient = getValue(item, ['ä¸»è¦æˆä»½', 'æˆä»½']);
            const pharmClass = getValue(item, ['è—¥ç†åˆ†é¡åç¨±', 'è—¥ç†åˆ†é¡']);
            const indication = getValue(item, ['é©æ‡‰ç—‡', 'é©æ‡‰ç—‡(ä¸­æ–‡)']);
            const storageLoc = getValue(item, ['å„²å­˜æ–¹å¼']);
            const nhiCode = getValue(item, ['å¥ä¿ç¢¼']);

            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-6 col-sm-12';
            col.innerHTML = `
                <div class="card drug-card" onclick='openDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <span class="badge badge-code">${code}</span>
                                ${nhiCode && nhiCode !== '0' ? `<span class="badge badge-nhi">${nhiCode}</span>` : ''}
                            </div>
                        </div>
                        
                        <h4 class="card-title fw-bold text-primary mb-1">${name}</h4>
                        ${chineseName ? `<h5 class="card-subtitle text-dark fw-bold mb-2">${chineseName}</h5>` : ''}
                        
                        <div class="text-secondary small mb-3"><i class="fas fa-flask me-1"></i>${ingredient}</div>
                        
                        ${pharmClass ? `<div class="badge bg-light text-dark border mb-3" style="white-space: normal; text-align:left;">${pharmClass}</div>` : ''}

                        ${ingredient ? `<div class="block-ingredient"><span class="block-label"><i class="fas fa-flask me-1"></i>ä¸»è¦æˆä»½</span><div class="block-content">${ingredient}</div></div>` : ''}
                        ${indication ? `<div class="block-indication"><span class="block-label"><i class="fas fa-stethoscope me-1"></i>é©æ‡‰ç—‡</span><div class="block-content">${indication}</div></div>` : ''}
                        
                        ${storageLoc ? `<div class="divider"></div><div class="text-end text-muted small">å„²ä½: ${storageLoc}</div>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(col);
        });

        if (totalItems > currentLimit) {
            const btn = document.createElement('button');
            btn.className = 'load-more-btn';
            btn.innerText = `â¬‡ï¸ é¡¯ç¤ºæ›´å¤šè³‡æ–™ (é‚„æœ‰ ${totalItems - currentLimit} ç­†)`;
            btn.onclick = loadMore;
            loadMoreContainer.appendChild(btn);
        }
    }

    window.openDetail = function(item) {
        const name = getValue(item, ['åç¨±', 'è—¥å“åç¨±']);
        const chineseName = getValue(item, ['ä¸­æ–‡å“å', 'ä¸­æ–‡åç¨±']);
        const code = getValue(item, ['ä»£ç¢¼', 'é™¢å…§ä»£ç¢¼']);
        const ingredient = getValue(item, ['ä¸»è¦æˆä»½', 'æˆä»½']);
        const pharmClass = getValue(item, ['è—¥ç†åˆ†é¡åç¨±', 'è—¥ç†åˆ†é¡']);
        const indication = getValue(item, ['é©æ‡‰ç—‡', 'é©æ‡‰ç—‡(ä¸­æ–‡)']);
        const dosage = getValue(item, ['åŠ‘é‡åŠç”¨æ³•', 'ç”¨æ³•ç”¨é‡']);
        const howToStore = getValue(item, ['è—¥å“è©²å¦‚ä½•å­˜æ”¾']);
        const nhiRule = getValue(item, ['è‡¨åºŠç”¨é€”(ä¸­æ–‡)']);
        const action = getValue(item, ['ä½œç”¨']);
        const warning = getValue(item, ['æ³¨æ„äº‹é …1', 'æ³¨æ„äº‹é …', 'è—¥å“è­¦èª(ä¸­æ–‡)']);
        const storageLoc = getValue(item, ['å„²å­˜æ–¹å¼']);
        const nhiCode = getValue(item, ['å¥ä¿ç¢¼']);

        document.getElementById('modalTitle').innerText = name;
        document.getElementById('modalChineseTitle').innerText = chineseName || '';
        document.getElementById('modalCode').innerText = code;
        document.getElementById('modalIngr').innerText = ingredient;
        document.getElementById('modalClass').innerText = pharmClass || 'æœªåˆ†é¡';
        
        const badgeNhi = document.getElementById('modalNhiCode');
        if(nhiCode && nhiCode !== '0') {
            badgeNhi.innerText = `å¥ä¿ç¢¼: ${nhiCode}`;
            badgeNhi.style.display = 'inline-block';
        } else {
            badgeNhi.style.display = 'none';
        }
        
        let html = '';
        if (ingredient) html += `<div class="block-ingredient"><span class="block-label"><i class="fas fa-flask me-1"></i>ä¸»è¦æˆä»½</span><div class="block-content">${ingredient}</div></div>`;
        if (indication) html += `<div class="block-indication"><span class="block-label"><i class="fas fa-stethoscope me-1"></i>é©æ‡‰ç—‡</span><div class="block-content">${indication}</div></div>`;
        if (dosage) html += `<div class="block-usage"><span class="block-label"><i class="fas fa-clock me-1"></i>åŠ‘é‡åŠç”¨æ³•</span><div class="block-content">${dosage}</div></div>`;
        if (howToStore) html += `<div class="block-storage"><span class="block-label"><i class="fas fa-temperature-low me-1"></i>è—¥å“è©²å¦‚ä½•å­˜æ”¾</span><div class="block-content">${howToStore}</div></div>`;

        if (nhiRule) html += `<div class="detail-title"><i class="fas fa-file-invoice-dollar me-2"></i>å¥ä¿çµ¦ä»˜è¦ç¯„</div><div class="detail-content text-content text-nhi">${nhiRule}</div>`;
        if (action) html += `<div class="detail-title"><i class="fas fa-bolt me-2"></i>ä½œç”¨</div><div class="detail-content text-content">${action}</div>`;
        if (warning) html += `<div class="detail-title text-danger"><i class="fas fa-exclamation-triangle me-2"></i>æ³¨æ„äº‹é …</div><div class="alert-box text-content">${warning}</div>`;
        if (storageLoc) html += `<div class="mt-4 text-end text-muted border-top pt-2">å€‰åº«/è—¥å±€å„²ä½ï¼š${storageLoc}</div>`;

        document.getElementById('modalBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('drugModal')).show();
    };
</script>
</body>
</html>
